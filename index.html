<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>D-File</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.1.3/axios.min.js"></script>
    <script src="https://unpkg.com/js-base64"></script>
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAMxJREFUOE+t06FuAkEQxvH/FxpegUoeovXUoOobJLapRDaw2T1b21qwoNGUB8BW45jwDmQJENIj3F2vd0wyZjL7m2QmK2qGar7nCLSGsadIF2hfgOLTvGZFQ47A/Xt0iFFG45jI5Kp+x9acfg71v4Dc4YKHTdDqDHSAQ2ZFzKkvLdH3LyDegGYqixcsvHkt0sDiXxcRz+Y1rw7AiwVN6wB9CxpXB8SreX1VByIDS/RRBxhaonACXGyzYwo8lrzEmgZP5rS+zWcqOTWzbQ96PEURUT++WAAAAABJRU5ErkJggg=="
    />
    <!-- <script src="https://cdn.bootcdn.net/ajax/libs/dayjs/1.11.7/dayjs.min.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/js-base64@3.7.5/base64.min.js"></script> -->
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html {
        padding: 20px 0 10px;
        background: #000;
        color: #fff;
      }
      body {
        font-size: 16px;
        max-width: 80%;
        margin: 0 auto;
      }
      h2 {
        margin-bottom: 10px;
      }
      .back {
        display: inline-block;
        border: 1px solid #ff9000;
        padding: 4px 12px;
        font-size: 15px;
        font-weight: normal;
        cursor: pointer;
        margin-left: 20px;
        margin-top: 0;
        background: #ff9000;
        color: #000;
        border-radius: 3px;
        transition: all 0.2s;
      }
      .back:hover {
        background: #000;
        color: #ff9000;
      }
      input.back {
        cursor: auto;
        background: #1b1b1b;
        border: 1px solid #333;
        color: #fff;
      }
      .ftr {
        float: right;
      }
      .file_list li {
        line-height: 40px;
        border-bottom: 1px solid #333;
        display: flex;
        align-items: center;
        padding: 6px 0;
        position: relative;
      }
      .w50 .file_list li {
        float: left;
        width: 31%;
        margin-right: 2%;
      }
      .w50 .file_list li span.sha {
        display: none;
      }
      .file_list li:before {
        content: "å…¶ä»–";
        background: #1b1b1b;
        color: #fff;
        min-width: 40px;
        padding: 0 10px;
        line-height: 26px;
        height: 26px;
        font-size: 13px;
        margin-right: 8px;
        text-align: center;
        border-radius: 3px;
      }
      .file_list li.dir:before {
        content: "æ–‡ä»¶å¤¹";
        background: #ff9000;
        color: #000;
      }
      .file_list li.img:before {
        content: "å›¾ç‰‡";
        background: #ff9000;
        color: #000;
      }
      .file_list li.video:before {
        content: "è§†é¢‘";
        background: #ff9000;
        color: #000;
      }
      .file_list li.music:before {
        content: "éŸ³é¢‘";
        background: #ff9000;
        color: #000;
      }
      .file_list li.code:before {
        content: "ä»£ç ";
        background: #ff9000;
        color: #000;
      }
      .file_list li.zip:before {
        content: "å‹ç¼©åŒ…";
        background: #ff9000;
        color: #000;
      }
      .file_list li.doc:before {
        content: "Word";
        background: #ff9000;
        color: #000;
      }
      .file_list li.xls:before {
        content: "Excel";
        background: #ff9000;
        color: #000;
      }
      .file_list li.ppt:before {
        content: "PPT";
        background: #ff9000;
        color: #000;
      }
      .file_list li.pdf:before {
        content: "PDF";
        background: #ff9000;
        color: #000;
      }
      .file_list li.txt:before {
        content: "æ–‡æœ¬";
        background: #ff9000;
        color: #000;
      }
      .file_list li img {
        margin-right: 6px;
        display: inline-block;
        vertical-align: middle;
      }
      .file_list li a {
        flex: 1;
        color: #fff;
        text-decoration: none;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .file_list li .size {
        margin: 0 10px;
        color: #666;
        font-size: 13px;
      }
      .file_list li .del {
        cursor: pointer;
        color: #ff9000;
        font-size: 13px;
        opacity: 0.7;
        transition: opacity 0.2s;
      }
      .file_list li .del:hover {
        opacity: 1;
      }
      .file_list li.dir a {
        text-decoration: underline;
        color: #ff9000;
        font-weight: bold;
      }
      .file_list li.dir .del {
        visibility: hidden;
        pointer-events: none;
      }
      .file_list li span {
        color: #999;
        font-size: 14px;
      }
      .file_list li span.sha {
        min-width: 350px;
        display: inline-block;
      }
      .file_list li i {
        border: 1px solid #ff9000;
        padding: 4px 12px;
        font-size: 14px;
        font-style: normal;
        cursor: pointer;
        margin-left: 10px;
        line-height: 20px;
        background: #ff9000;
        color: #000;
        border-radius: 3px;
        transition: all 0.2s;
      }
      .file_list li i:hover {
        background: #000;
        color: #ff9000;
      }
      .file-img {
        width: 60px;
        max-height: 60px;
      }
      li {
        list-style-type: none;
      }
      @media screen and (max-width: 700px) {
        body {
          max-width: 100%;
          padding: 0 15px;
          -webkit-tap-highlight-color: transparent;
        }
        
        /* ä¼˜åŒ–æ ‡é¢˜æ˜¾ç¤º */
        h2 {
          font-size: 18px;
          padding: 12px 0;
          margin-bottom: 15px;
          display: flex;
          align-items: center;
          flex-wrap: wrap;
          gap: 8px;
        }

        h2 i {
          width: 100%;
          margin-bottom: 8px;
          font-size: 14px;
          color: #666;
        }

        /* ä¼˜åŒ–æŒ‰é’®æ ·å¼ */
        .back {
          padding: 6px 12px;
          font-size: 14px;
          margin-left: 0;
          height: 32px;
          min-width: 60px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
        }

        .back.ftr {
          display: inline-flex !important;
        }

        /* ä¼˜åŒ–æœç´¢æ¡† */
        input#search {
          display: block;
          margin: 12px 0;
          width: 100%;
          min-width: unset;
          height: 40px;
          font-size: 16px;
        }

        /* ä¼˜åŒ–æŒ‰é’®ç»„ */
        #btn-wrap {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
          gap: 8px;
          margin: 12px 0;
          width: 100%;
        }

        #btn-wrap button {
          margin: 0;
          font-size: 14px;
          padding: 6px 12px;
          height: 32px;
          width: 100%;
          white-space: nowrap;
        }

        /* ä¼˜åŒ–æ–‡ä»¶åˆ—è¡¨ */
        .file_list {
          margin-top: 15px;
        }

        .file_list li {
          padding: 8px 0;
          line-height: 1.4;
          flex-wrap: wrap;
          gap: 4px;
        }

        .file_list li a {
          width: calc(100% - 100px);
          font-size: 15px;
          line-height: 24px;
          padding: 4px 0;
        }

        .file_list li .size {
          margin: 0;
          font-size: 12px;
          min-width: 50px;
          text-align: right;
        }

        .file_list li .del {
          position: absolute;
          right: 0;
          top: 50%;
          transform: translateY(-50%);
          padding: 4px 8px;
          background: rgba(255, 144, 0, 0.1);
          border-radius: 3px;
        }

        .file_list li:before {
          min-width: 50px;
          padding: 0 8px;
          line-height: 24px;
          height: 24px;
          font-size: 12px;
          flex-shrink: 0;
          margin-right: 8px;
        }

        .file_list li.dir a {
          color: #ff9000;
        }

        /* ä¼˜åŒ–ç©ºæ–‡ä»¶å¤¹æç¤º */
        .empty-folder-hint {
          padding: 30px 20px;
          margin: 15px 0;
        }

        .empty-folder-hint i {
          font-size: 32px;
          margin-bottom: 10px;
        }

        .empty-folder-hint p {
          font-size: 14px;
        }

        /* è§¦æ‘¸ä¼˜åŒ– */
        a, button, .back {
          touch-action: manipulation;
          -webkit-touch-callout: none;
        }

        /* ä¼˜åŒ–åŠ è½½çŠ¶æ€ */
        .loading {
          padding: 20px;
          text-align: center;
          font-size: 14px;
        }

        /* ä¼˜åŒ–æ“ä½œæŒ‰é’®å¸ƒå±€ */
        .operation-buttons {
          display: flex;
          flex-wrap: wrap;
          gap: 8px;
          margin-top: 8px;
          width: 100%;
        }

        /* ä¼˜åŒ–æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º */
        .file-info {
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 12px;
          color: #666;
        }
      }
      @media screen and (max-width: 700px) {
        /* ä¼˜åŒ–è§¦æ‘¸äº¤äº’ */
        .file_list li {
          position: relative;
          padding: 8px 0;
          line-height: 1.4;
          flex-wrap: wrap;
          gap: 4px;
          touch-action: pan-y;
          -webkit-tap-highlight-color: transparent;
        }

        .file_list li a {
          display: flex;
          align-items: center;
          width: calc(100% - 60px);
          min-height: 44px;
          font-size: 15px;
          padding: 4px 0;
          touch-action: manipulation;
        }

        .file_list li .del {
          position: absolute;
          right: 0;
          top: 50%;
          transform: translateY(-50%);
          padding: 8px 12px;
          min-height: 44px;
          display: flex;
          align-items: center;
          justify-content: center;
          background: rgba(255, 144, 0, 0.1);
          border-radius: 3px;
          touch-action: manipulation;
        }

        .file_list li:active {
          background: rgba(255, 144, 0, 0.05);
        }

        .file_list li .del:active {
          background: rgba(255, 144, 0, 0.2);
        }

        /* ä¼˜åŒ–æŒ‰é’®è§¦æ‘¸åŒºåŸŸ */
        .back, button {
          min-height: 44px;
          padding: 8px 16px;
          touch-action: manipulation;
        }

        #btn-wrap button {
          min-height: 44px;
          padding: 8px 12px;
        }

        /* ä¼˜åŒ–æœç´¢æ¡† */
        input#search {
          height: 44px;
          font-size: 16px;
          border-radius: 4px;
        }

        /* ä¼˜åŒ–æ ¹ç›®å½•é€‰æ‹© */
        #rootdm {
          height: 44px;
          font-size: 16px;
          border-radius: 4px;
        }

        /* ä¼˜åŒ–æ ‡é¢˜åŒºåŸŸ */
        h2 {
          display: flex;
          flex-wrap: wrap;
          gap: 8px;
          padding: 12px 0;
        }

        h2 i {
          width: 100%;
          margin-bottom: 8px;
          font-size: 14px;
          color: #666;
        }

        /* ä¼˜åŒ–æ“ä½œæŒ‰é’®ç»„ */
        .operation-buttons {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
          gap: 8px;
          width: 100%;
          margin-top: 8px;
        }

        /* ä¼˜åŒ–æ‹–æ”¾åŒºåŸŸ */
        #drop-zone {
          min-height: calc(100vh - 160px) !important;
        }

        .drag-hint {
          padding: 16px;
          margin: 12px 0;
          font-size: 14px;
          text-align: center;
          background: rgba(255, 144, 0, 0.1);
          border-radius: 8px;
        }

        /* ä¼˜åŒ–åŠ è½½çŠ¶æ€ */
        #loading {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          padding: 12px 24px;
          background: rgba(0, 0, 0, 0.8);
          border-radius: 4px;
          z-index: 1000;
        }

        /* ä¼˜åŒ–ç©ºçŠ¶æ€ */
        .empty-folder-hint {
          padding: 32px 16px;
          margin: 16px 0;
          border: 2px dashed rgba(255, 144, 0, 0.3);
          border-radius: 8px;
          text-align: center;
        }

        .empty-folder-hint i {
          font-size: 32px;
          margin-bottom: 12px;
        }

        .empty-folder-hint p {
          font-size: 14px;
          line-height: 1.5;
        }
      }
      input {
        background: #1b1b1b;
        outline: none;
        line-height: 26px;
        border: 1px solid #333;
        padding: 0 10px;
        display: inline-block;
        min-width: 280px;
        margin-top: 6px;
        color: #fff;
        border-radius: 3px;
      }
      button {
        outline: none;
        background: #1b1b1b;
        border: 1px solid #333;
        display: inline-block;
        margin-left: 10px;
        line-height: 18px;
        padding: 4px 10px;
        cursor: pointer;
        color: #fff;
        border-radius: 3px;
        transition: all 0.2s;
      }
      button:hover {
        border-color: #ff9000;
      }
      button span {
        color: #ff9000;
        display: block;
      }
      #file {
        display: none;
      }
      h4 {
        overflow: hidden;
        margin-bottom: 20px;
      }
      h2 {
        padding: 10px 0;
        margin-bottom: 10px;
        border-bottom: 1px solid #333;
        overflow: hidden;
      }
      .tip {
        color: #999;
        font-size: 12px;
        margin-left: 20px;
      }
      i {
        font-style: normal;
      }
      .hide {
        display: none !important;
      }
      #loading {
        position: fixed;
        width: 100vw;
        height: 100vh;
        left: 0;
        top: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ff9000;
        z-index: 9;
        font-size: 20px;
      }
      .drag-hint {
        background: rgba(255, 144, 0, 0.1);
        padding: 8px;
        border-radius: 4px;
        margin-bottom: 15px;
        border: 1px dashed #ff9000;
        color: #ff9000;
        text-align: center;
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0% { opacity: 0.6; }
        50% { opacity: 1; }
        100% { opacity: 0.6; }
      }
      #drop-zone {
        transition: all 0.3s ease;
        position: relative;
      }
      #drop-zone.dragover {
        background: rgba(255, 144, 0, 0.1) !important;
      }
      #drop-zone.dragover:after {
        content: 'å¯ä»¥æ‹–æ”¾å¤šä¸ªæ–‡ä»¶åˆ°è¿™é‡Œä¸Šä¼ ';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
        color: #ff9000;
        pointer-events: none;
      }
      .empty-folder-hint {
        text-align: center;
        padding: 40px 20px;
        border: 2px dashed #ff9000;
        border-radius: 8px;
        margin: 20px 0;
        background: rgba(255, 144, 0, 0.05);
        transition: all 0.3s ease;
      }
      .empty-folder-hint:hover {
        background: rgba(255, 144, 0, 0.1);
      }
      .empty-folder-hint i {
        font-size: 40px;
        color: #ff9000;
        margin-bottom: 15px;
        display: block;
      }
      @media screen and (max-width: 700px) {
        #drop-zone.dragover:after {
          font-size: 16px;
        }
      }
    </style>
  </head>
  <body>
    <div id="drop-zone" style="min-height: calc(100vh - 200px); position: relative;" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
      <div class="drag-hint">
        ğŸ’¡ æ”¯æŒæ‹–æ‹½ä¸Šä¼ ï¼šç›´æ¥å°†æ–‡ä»¶æ‹–æ”¾åˆ°é¡µé¢ä»»æ„ä½ç½®å³å¯ä¸Šä¼ 
      </div>
      <p style="margin: 0">
        ç‰ˆæœ¬å·: 20250101-1
        <span class="tip">æµ‹è¯•å»¶è¿Ÿè¯·åœ¨æ ¹ç›®å½•ä¸Šä¼ <b>init.jpg</b>(50kbä»¥å†…)</span>
      </p>
      <h4>
        æ ¹åŸŸå: <input type="text" value="" id="rootdm" />
        <div id="btn-wrap"></div>
      </h4>
      <input type="file" id="file" class="filepond" name="filepond" />
      <h2>
        å½“å‰ç›®å½•ï¼š<i id="repo"></i>
        <div class="operation-buttons">
          <span onclick="addDir()" class="back">æ–°å»ºç›®å½•</span>
          <span onclick="document.getElementById('file').click()" class="back">ä¸Šä¼ æ–‡ä»¶</span>
          <span onclick="dirBack()" class="back">è¿”å›ä¸Šçº§</span>
          <span onclick="refresh()" class="back">åˆ·æ–°</span>
          <span onclick="toggleWrap()" class="back">åˆ‡æ¢è§†å›¾</span>
          <span onclick="updateToken()" class="back">è®¾ç½®Token</span>
          <span onclick="updateRepo()" class="back">è®¾ç½®Repo</span>
        </div>
        <input
          type="text"
          class="back"
          id="search"
          placeholder="å…³é”®è¯æœç´¢, å›è½¦ç¡®è®¤"
          onkeyup="search(event)"
        />
      </h2>
      <div id="file_wrap">
        <ul class="file_list" id="file_list">
          åŠ è½½ä¸­...
        </ul>
      </div>
      <div id="loading" class="hide">å¤„ç†ä¸­...</div>
    </div>

    <script>
      window.baseRepo = localStorage.getItem("GIT_REPO") || "dhjz/file";
      window.baseToken = localStorage.getItem("GIT_TOKEN") || "";
      if (!baseToken) alert("è¯·å…ˆè®¾ç½®ä»“åº“å’Œtoken");

      function toggleWrap() {
        var wrap = document.getElementById("file_wrap");
        wrap.className = wrap.className ? "" : "w50";
      }
      let urls = [
        { name: "æœ¬ç«™", url: location.href },
        {
          name: "gitmirroråŠ é€Ÿ",
          url: `https://raw.gitmirror.com/${baseRepo}/master/`,
        },
        {
          name: "jsdelivråŠ é€Ÿ",
          url: `https://gcore.jsdelivr.net/gh/${baseRepo}@master/`,
        },
        {
          name: "jsdelivr1åŠ é€Ÿ",
          url: `https://cdn.jsdelivr.net/gh/${baseRepo}/`,
        },
      ];

      function initBtn() {
        let btnEl = document.getElementById("btn-wrap");
        for (let j = 0; j < urls.length; j++) {
          const temp = urls[j];
          const btn = document.createElement("button");
          btn.innerHTML = temp.name + `<span id="btn${j}"></span>`;
          let ig = new Image();
          ig.src = temp.url + "init.jpg?t=" + new Date().getTime();
          let start = new Date().getTime();
          ig.onload = function () {
            document.getElementById(`btn${j}`).innerHTML =
              new Date().getTime() - start + "ms";
          };
          ig.onerror = function () {
            document.getElementById(`btn${j}`).innerHTML = "å»¶è¿Ÿè¿‡é«˜";
          };
          btn.onclick = function () {
            document.getElementById("rootdm").value = temp.url;
            initFileList();
          };
          btnEl.append(btn);
        }
      }
      initBtn();

      window.request = axios.create({
        baseURL: "https://api.github.com/",
        timeout: 30000,
        headers: {
          Authorization: "Bearer " + baseToken,
          Accept: "application/vnd.github+json",
          "X-GitHub-Api-Version": "2022-11-28",
        },
      });
      request.interceptors.response.use(
        function (response) {
          console.log("è¯·æ±‚æˆåŠŸ", response);
          hideLoading();
          return response;
        },
        function (error) {
          console.error("è¯·æ±‚å¤±è´¥", error);
          hideLoading();
          const errorMsg = document.createElement('div');
          errorMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,0,0,0.1);padding:15px;border-radius:4px;z-index:1000;';
          errorMsg.textContent = error.response?.data?.message || 'è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒTokenè®¾ç½®';
          document.body.appendChild(errorMsg);
          setTimeout(() => errorMsg.remove(), 3000);
          return Promise.reject(error);
        }
      );

      window.paths = [];
      window.en = Base64.encode;
      window.de = Base64.decode;

      window.fileList = [];
      function initFileList(searchVal) {
        let rootdm = document.getElementById("rootdm").value || "";
        let tempList = window.fileList;
        if (searchVal && searchVal.trim()) {
          tempList = window.fileList.filter((item) =>
            item.name.includes(searchVal.trim())
          );
        }
        if (window.fileList.length) {
          document.getElementById("file_list").innerHTML = tempList
            .map((item) => {
              const isDir = item.type === "dir";
              const itemPath = item.path;
              return `<li class="file ${item.ftype}">
                <a href="javascript:void(0)" onclick="handleItemClick('${itemPath}', ${isDir})">${item.name}</a>
                <span class='sha'>${item.sha}</span>
                <span class="size">${isDir ? '' : getUnit(item.size)}</span>
                <i onclick="delOne('${itemPath}', '${item.sha}')" class="del">åˆ é™¤</i>
              </li>`;
            })
            .join("");
        } else {
          document.getElementById("file_list").innerHTML = `
            <div class="empty-folder-hint">
              <i>ğŸ“</i>
              <p>å½“å‰æ–‡ä»¶å¤¹ä¸ºç©º</p>
              <p style="margin-top: 10px; font-size: 14px; color: #999;">
                æ‹–æ”¾æ–‡ä»¶åˆ°è¿™é‡Œä¸Šä¼ ï¼Œæˆ–ç‚¹å‡»é¡¶éƒ¨çš„"ä¸Šä¼ æ–‡ä»¶"æŒ‰é’®
              </p>
            </div>
          `;
        }

        document.getElementById("repo").innerHTML =
          baseRepo + "/" + (paths.length ? paths[paths.length - 1] : "");
      }

      function handleItemClick(path, isDir) {
        if (isDir) {
          getDir(path, false);
        } else {
          const rootdm = document.getElementById("rootdm").value || "";
          window.open(rootdm + path, '_blank');
        }
      }

      // åˆå§‹åŒ–æ ¹ç›®å½•
      if (baseToken) getDir("", true);

      function getDir(path, isRoot, event, isBack) {
        if (!path && !isRoot) return;
        if (event) event.preventDefault();
        showLoading();
        
        // æ£€æŸ¥Tokenæ˜¯å¦è®¾ç½®
        if (!baseToken) {
          hideLoading();
          const msg = document.createElement('div');
          msg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,0,0,0.1);padding:15px;border-radius:4px;z-index:1000;';
          msg.textContent = 'è¯·å…ˆè®¾ç½®Token';
          document.body.appendChild(msg);
          setTimeout(() => msg.remove(), 3000);
          return;
        }

        getContent(path + "?t=" + new Date().getTime())
          .then((data) => {
            console.log("è·å–ç›®å½•å†…å®¹:", data);
            window.fileList = (data || [])
              .filter((d) => d.name != "init.jpg")
              .map((item) => {
                item.ftype = getType(item.name);
                if (item.type == "dir") item.ftype = "dir";
                return item;
              });
            window.fileList.sort((a, b) => (a.type < b.type ? -1 : 1));
            if (path && !isBack) paths.push(path);
            initFileList();
          })
          .catch((error) => {
            console.error("è·å–ç›®å½•å¤±è´¥:", error);
            hideLoading();
            window.fileList = [];
            initFileList();
          });
      }

      function addDir() {
        const val = prompt("è¯·è¾“å…¥æ–°å»ºç›®å½•åç§°, åŸºäºæ ¹ç›®å½•, ä¸ä»¥/å¼€å¤´", "");
        if (val) {
          putDir(val);
        }
      }

      function dirBack() {
        if (!paths.length) return alert("å·²ç»æ˜¯æ ¹ç›®å½•äº†!");
        paths.pop();
        if (paths.length) {
          getDir(paths[paths.length - 1], false, null, true);
        } else {
          getDir("", true, null, true);
        }
      }

      function refresh() {
        if (paths.length) {
          getDir(paths[paths.length - 1], false, null, true);
        } else {
          getDir("", true, null, true);
        }
      }

      function search(e) {
        if (e.keyCode == 13) {
          initFileList(document.getElementById("search").value);
        }
      }

      function delOne(path, sha) {
        if (path == "index.html") return alert("ä¸»é¡µindex.htmlä¸èƒ½è¢«åˆ é™¤!");
        if (window.confirm("æ˜¯å¦ç¡®è®¤åˆ é™¤æ”¹æ–‡ä»¶: " + path)) {
          delFile(path, sha, true);
        }
      }

      // putContent('ip.txt', base64Str)
      document.getElementById("file").addEventListener("input", (e) => {
        const file = e.target.files[0];
        if (file)
          putFile(
            paths.length
              ? paths[paths.length - 1] + "/" + file.name
              : file.name,
            file
          );
        document.getElementById("file").value = "";
      });

      function updateRepo() {
        const val = prompt(
          "è¯·è¾“å…¥ä»“åº“ {owner}/{repo}",
          localStorage.getItem("GIT_REPO") || "dhjz/file"
        );
        if (val) localStorage.setItem("GIT_REPO", val) || location.reload();
      }

      function updateToken() {
        const val = prompt(
          "è¯·è¾“å…¥token",
          localStorage.getItem("GIT_TOKEN") || ""
        );
        if (val) localStorage.setItem("GIT_TOKEN", val) || location.reload();
      }

      function getSha(path) {
        return new Promise((reso, rej) => {
          request
            .get(`/repos/${baseRepo}/contents/${path}`)
            .then((res) => reso(res.data.sha))
            .catch(() => reso(null));
        });
      }

      function getContent(path, isFull) {
        showLoading();
        if (isFull) return request.get(`/repos/${baseRepo}/contents/${path}`);

        return new Promise((reso, rej) => {
          request
            .get(`/repos/${baseRepo}/contents/${path}`)
            .then((res) => {
              hideLoading();
              if (Array.isArray(res.data)) return reso(res.data);
              reso(Base64.decode(res.data.content));
            })
            .catch((error) => {
              hideLoading();
              console.error("è·å–æ–‡ä»¶å†…å®¹å¤±è´¥: " + path, error);
              // å¦‚æœæ˜¯404é”™è¯¯ï¼Œè¯´æ˜ç›®å½•ä¸ºç©º
              if (error.response?.status === 404) {
                reso([]);
              } else {
                reso(null);
              }
            });
        });
      }

      function putContent(path, content) {
        const data = {
          message: now() + " update " + path,
          content: Base64.encode(content),
        };

        getSha(path).then((sha) => {
          if (sha) data.sha = sha;
          request.put(`/repos/${baseRepo}/contents/${path}`, data);
        });
      }

      function putDir(path) {
        const data = {
          message: now() + " create dir " + path,
          content: "",
        };

        getContent(path).then((res) => {
          if (Array.isArray(res)) return alert("è¯¥ç›®å½•å·²å­˜åœ¨");
          request
            .put(
              `/repos/${baseRepo}/contents/${path}${
                path.endsWith("/") ? "" : "/"
              }.init`,
              data
            )
            .then(() => {
              alert("æ–°å»ºç›®å½•æˆåŠŸ: " + path);
              refresh();
            });
        });
      }

      function delFile(path, sha, isTip) {
        // getSha(path).then((sha) => {
        // }).catch((e) => console.log('not exit file: ' + path))
        request
          .delete(`/repos/${baseRepo}/contents/${path}`, {
            params: {
              message: now() + " del " + path,
              sha,
            },
          })
          .then(() => {
            if (isTip) alert("åˆ é™¤æ–‡ä»¶æˆåŠŸ:" + path);
            refresh();
          });
      }

      // æ·»åŠ æ–‡ä»¶ä¸Šä¼ é˜Ÿåˆ—ç®¡ç†
      class UploadQueue {
        constructor(concurrency = 3) {
          this.queue = [];
          this.running = 0;
          this.concurrency = concurrency;
          this.results = [];
        }

        add(file, targetPath) {
          return new Promise((resolve, reject) => {
            this.queue.push({
              file,
              targetPath,
              resolve,
              reject,
              retries: 0
            });
            this.processNext();
          });
        }

        async processNext() {
          if (this.running >= this.concurrency || this.queue.length === 0) return;
          
          this.running++;
          const task = this.queue.shift();
          const { file, targetPath, resolve, reject, retries } = task;

          try {
            await this.uploadFile(file, targetPath, retries);
            this.results.push({ success: true, file: file.name });
            resolve();
          } catch (error) {
            console.error(`ä¸Šä¼ å¤±è´¥ (é‡è¯•æ¬¡æ•°: ${retries}):`, error);
            if (retries < 3) {
              console.log(`é‡è¯•ä¸Šä¼ : ${file.name}`);
              this.queue.push({...task, retries: retries + 1});
            } else {
              this.results.push({ success: false, file: file.name, error });
              reject(error);
            }
          } finally {
            this.running--;
            this.processNext();
          }
        }

        async uploadFile(file, targetPath, retryCount) {
          const sha = await getSha(targetPath);
          if (sha && !window.confirm(`å·²å­˜åœ¨è¯¥æ–‡ä»¶: ${targetPath}, æ˜¯å¦è¦†ç›–?`)) {
            throw new Error('ç”¨æˆ·å–æ¶ˆè¦†ç›–');
          }

          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsArrayBuffer(file);
            
            reader.onload = async () => {
              try {
                const arrayBuffer = reader.result;
                const blob = new Blob([arrayBuffer], { type: file.type });
                const content = await blob.arrayBuffer();
                const data = {
                  message: now() + " update " + targetPath,
                  content: btoa(chunkChar(new Uint8Array(content))),
                  sha,
                };

                await request.put(`/repos/${baseRepo}/contents/${targetPath}`, data, {
                  headers: { "Content-Type": file.type }
                });
                resolve();
              } catch (err) {
                reject(err);
              }
            };
            
            reader.onerror = (err) => reject(err);
          });
        }

        isComplete() {
          return this.queue.length === 0 && this.running === 0;
        }

        getResults() {
          return this.results;
        }
      }

      function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('drop-zone').classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length === 0) return;

        const uploadQueue = new UploadQueue(3); // æœ€å¤š3ä¸ªå¹¶å‘ä¸Šä¼ 
        showLoading(`å‡†å¤‡ä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶...`);
        console.log('å¼€å§‹å¤„ç†æ‹–æ‹½çš„æ–‡ä»¶:', files.length, 'ä¸ªæ–‡ä»¶');
        
        let processed = 0;
        const totalFiles = files.length;
        const promises = [];

        Array.from(files).forEach((file, index) => {
          const targetPath = paths.length
            ? paths[paths.length - 1] + "/" + file.name
            : file.name;
          
          promises.push(
            uploadQueue.add(file, targetPath)
              .then(() => {
                processed++;
                console.log(`æ–‡ä»¶ ${file.name} ä¸Šä¼ æˆåŠŸï¼Œå·²å¤„ç† ${processed}/${totalFiles}`);
                showLoading(`æ­£åœ¨ä¸Šä¼ ç¬¬ ${processed}/${totalFiles} ä¸ªæ–‡ä»¶...`);
              })
              .catch(err => {
                console.error(`æ–‡ä»¶ ${file.name} ä¸Šä¼ å¤±è´¥:`, err);
              })
          );
        });

        // ç­‰å¾…æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆ
        Promise.allSettled(promises).then(() => {
          const results = uploadQueue.getResults();
          const successful = results.filter(r => r.success).length;
          const failed = results.filter(r => !r.success).length;
          
          if (failed > 0) {
            const failedFiles = results.filter(r => !r.success).map(r => r.file).join(', ');
            alert(`ä¸Šä¼ å®Œæˆã€‚\næˆåŠŸ: ${successful} ä¸ªæ–‡ä»¶\nå¤±è´¥: ${failed} ä¸ªæ–‡ä»¶\n\nå¤±è´¥çš„æ–‡ä»¶: ${failedFiles}`);
          } else {
            alert(`æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼å…± ${successful} ä¸ªæ–‡ä»¶ã€‚`);
          }
          
          setTimeout(() => {
            refresh();
            hideLoading();
          }, 1000);
        });
      }

      function putFile(path, file) {
        const uploadQueue = new UploadQueue(1);
        showLoading(`æ­£åœ¨ä¸Šä¼ : ${path}`);
        
        uploadQueue.add(file, path)
          .then(() => {
            alert("ä¸Šä¼ æˆåŠŸ:" + path + ", å¤§å°:" + getUnit(file.size));
            refresh();
          })
          .catch(err => {
            console.error("æ–‡ä»¶ä¸Šä¼ å¤±è´¥:", path, err);
            alert("ä¸Šä¼ å¤±è´¥:" + path + ", è¯·é‡è¯•");
          })
          .finally(() => {
            hideLoading();
          });
      }

      function chunkChar(arr) {
        // content: btoa(String.fromCharCode(...new TextEncoder().encode(content))) ä¸å¤ªè¡Œ
        // String.fromCharCode()æ–¹æ³•æœ€å¤šå¯ä»¥æ¥å—65535ä¸ªå‚æ•°
        const chunkSize = 10000;
        const chunks = [];
        for (let i = 0; i < arr.length; i += chunkSize) {
          chunks.push(arr.slice(i, i + chunkSize));
        }
        const strings = chunks.map((chunk) => String.fromCharCode(...chunk));
        return strings.join("");
      }

      function now() {
        return new Date(new Date().getTime() + 8 * 60 * 60 * 1000)
          .toISOString()
          .replace("T", " ")
          .substring(0, 19);
      }

      function getType(val) {
        if (/\.(jpg|jpeg|png|gif)$/i.test(val)) return "img";
        if (/\.(mp4|avi|mov|wmv|flv)$/i.test(val)) return "video";
        if (/\.(mp3|wav|wma|aac)$/i.test(val)) return "music";
        if (/\.(doc|docx|odt)$/i.test(val)) return "doc";
        if (/\.(xls|xlsx)$/i.test(val)) return "xls";
        if (/\.(ppt|pptx)$/i.test(val)) return "ppt";
        if (/\.(pdf)$/i.test(val)) return "pdf";
        if (/\.(txt|ini|properties|yml|json|md)$/i.test(val)) return "txt";
        if (/\.(java|html|htm|css|js|php|h|go|)$/i.test(val)) return "code";
        if (/\.(zip|rar|7z|tar\.gz|tar\.bz2)$/i.test(val)) return "zip";
        return "other";
      }

      function getUnit(bytes, decimals = 2) {
        if (bytes === 0) return "0B";

        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ["B", "KB", "MB", "GB", "TB", "PB", "EB", "ZB", "YB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));

        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + "" + sizes[i];
      }

      function showLoading(val) {
        document.getElementById("loading").innerHTML = val || "å¤„ç†ä¸­...";
        document.getElementById("loading").className = "";
      }

      function hideLoading() {
        document.getElementById("loading").className = "hide";
      }

      // Add drag and drop handlers
      function handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('drop-zone').classList.add('dragover');
      }

      function handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('drop-zone').classList.remove('dragover');
      }
    </script>

    <style>
      .gg-folder {
        transform: scale(var(--ggs, 1));
      }
      .gg-folder,
      .gg-folder::after {
        box-sizing: border-box;
        position: relative;
        display: block;
        width: 22px;
        height: 16px;
        border: 2px solid;
        border-radius: 3px;
      }
      .gg-folder::after {
        content: "";
        position: absolute;
        width: 10px;
        height: 4px;
        border-bottom: 0;
        border-top-left-radius: 2px;
        border-top-right-radius: 4px;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        top: -5px;
      }
      .gg-file {
        box-sizing: border-box;
        position: relative;
        display: block;
        transform: scale(var(--ggs, 1));
        width: 14px;
        height: 16px;
        border: 2px solid transparent;
        border-right: 0;
        border-top: 0;
        box-shadow: 0 0 0 2px;
        border-radius: 1px;
        border-top-right-radius: 4px;
        overflow: hidden;
      }
      .gg-file::after {
        content: "";
        display: block;
        box-sizing: border-box;
        position: absolute;
        width: 6px;
        height: 6px;
        border-left: 2px solid;
        border-bottom: 2px solid;
        right: -1px;
        top: -1px;
      }
      .gg-image {
        box-sizing: border-box;
        position: relative;
        display: block;
        transform: scale(var(--ggs, 1));
        width: 20px;
        height: 16px;
        overflow: hidden;
        box-shadow: 0 0 0 2px;
        border-radius: 2px;
      }
      .gg-image::after,
      .gg-image::before {
        content: "";
        display: block;
        box-sizing: border-box;
        position: absolute;
        border: 2px solid;
      }
      .gg-image::after {
        transform: rotate(45deg);
        border-radius: 3px;
        width: 16px;
        height: 16px;
        top: 9px;
        left: 6px;
      }
      .gg-image::before {
        width: 6px;
        height: 6px;
        border-radius: 100%;
        top: 2px;
        left: 2px;
      }
      .gg-camera {
        box-sizing: border-box;
        position: relative;
        display: block;
        transform: scale(var(--ggs, 1));
        border: 2px solid;
        border-radius: 3px;
        width: 18px;
        height: 12px;
        perspective: 24px;
      }
      .gg-camera::after,
      .gg-camera::before {
        content: "";
        display: block;
        box-sizing: border-box;
        position: absolute;
      }
      .gg-camera::before {
        border: 2px solid;
        border-left-color: transparent;
        transform: rotateY(-70deg);
        width: 8px;
        height: 8px;
        right: -7px;
        top: 0;
      }
      .gg-camera::after {
        width: 10px;
        height: 5px;
        border-top: 2px solid;
        border-right: 2px solid;
        top: -5px;
        right: 2px;
        border-top-right-radius: 2px;
      }
      .gg-file.pdf:before {
        content: "pdf";
        font-size: 15px;
        position: absolute;
        bottom: -46%;
        font-style: normal;
        transform: scale(0.5) translateX(-54%);
      }
      .gg-file.doc:before {
        content: "doc";
        font-size: 15px;
        position: absolute;
        bottom: -46%;
        font-style: normal;
        transform: scale(0.5) translateX(-54%);
      }
    </style>
  </body>
</html>
